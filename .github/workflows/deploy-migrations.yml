name: Deploy Migrations

on:
  push:
    branches: [main]
    paths:
      - "supabase/migrations/**/*.sql"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

concurrency:
  group: deploy-migrations-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    env:
      # Supabase config.toml で参照される環境変数のダミー値
      SEND_EMAIL_HOOK_SECRETS: "v1,whsec_dummysecret1234567890abcdefghijk"
      SUPABASE_AUTH_EXTERNAL_GOOGLE_CLIENT_ID: "dummy-client-id"
      SUPABASE_AUTH_EXTERNAL_GOOGLE_SECRET: "dummy-secret"
      SUPABASE_AUTH_EXTERNAL_TWITCH_CLIENT_ID: "dummy-client-id"
      SUPABASE_AUTH_EXTERNAL_TWITCH_SECRET: "dummy-secret"

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: 2.70.5

      - name: Verify migration files
        run: |
          if [ ! -d supabase/migrations ]; then
            echo "::error::Migrations directory 'supabase/migrations' does not exist."
            exit 1
          fi

          echo "=== Migration count ==="
          MIGRATION_COUNT=$(find supabase/migrations -name "*.sql" -type f | wc -l)
          echo "Found ${MIGRATION_COUNT} migration file(s)."

          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "::error::No migration files found in supabase/migrations/"
            exit 1
          fi

          echo ""
          echo "=== Listing migration files ==="
          ls -lh supabase/migrations/

      - name: Link to Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_ID"

      - name: Check database connectivity
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "=== Checking connectivity with dry-run ==="
          supabase db push --dry-run

      - name: Deploy migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "=== Deploying migrations to Cloud Supabase ==="
          supabase db push

      - name: Verify deployment
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "=== Verifying deployment by checking for pending migrations (dry run) ==="
          supabase db push --dry-run
          echo "Verification completed: Supabase CLI reported no errors when checking for pending migrations."

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Migration deployment failed. Please check the logs and verify your Supabase credentials."
          echo "::error::Consider rolling back manually if necessary."
